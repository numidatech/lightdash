name: Build & Deploy to Numida Docker Hub

on:
  pull_request:
    branches:
      - 'numida'
  push:
    tags:
      - '*'
      - '!*-alpha*'
      - '!*-beta*'

    branches:
      - 'numida'

  workflow_dispatch:


jobs:
  docker-deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Connect to Tailscale
        uses: tailscale/github-action@v3
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_CLIENT_SECRET }}
          hostname: lightdash-builder
          version: latest
          tags: tag:dataplex

      - name: executing remote ssh commands using password
        uses: appleboy/ssh-action@v1.0.3
        with:
          key: ${{ secrets.KEY }}
          host: ${{ secrets.LIGHTDASH_HOST }}
          username: ${{ secrets.USERNAME }}
          # Ensure the script exists on the lightdash host
          script: ./bin/deploy_docker_numida